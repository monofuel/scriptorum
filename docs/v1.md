# V1 Progress

The following V1 steps are already completed in this repository:

- [x] CLI scaffold exists with core commands: `--init`, `run`, `status`, `plan`, `worktrees`, `--version`, and `--help`.
- [x] `scriptorium --init` is implemented.
- [x] Init validates preconditions: target must be a git repository and must not already have a `scriptorium/plan` branch.
- [x] Init creates the orphan `scriptorium/plan` branch and writes planning files/directories: `areas/`, `tickets/open/`, `tickets/in-progress/`, `tickets/done/`, `decisions/`, and `spec.md` placeholder.
- [x] Init creates the initial commit on the plan branch (`scriptorium: initialize plan branch`).
- [x] Runtime config support exists via `scriptorium.json` with defaults for missing values.
- [x] Model-to-harness routing is implemented (`claude-*` -> `claude-code`, `codex-*`/`gpt-*` -> `codex`, otherwise `typoi`).
- [x] Test coverage exists for init behavior and config loading/routing (`tests/test_scriptorium.nim`).
- [x] `make test` runs the Nim test files (`tests/test_*.nim`).
- [x] CI is wired to run tests on push and pull request (`.github/workflows/build.yml`).

## Remaining Steps To Reach V1 (Detailed And Testable)

- [x] `V1-01` Create `src/scriptorium/orchestrator.nim` with a public `runOrchestrator*(repoPath: string)` entry point. Test: `nim check src/scriptorium/orchestrator.nim`.
- [x] `V1-02` Wire `cmdRun()` in `src/scriptorium.nim` to call `runOrchestrator(getCurrentDir())`. Test: `nim r src/scriptorium.nim run` no longer prints "not yet implemented".
- [x] `V1-03` Start an HTTP MCP server inside the run loop using config endpoint values. Test: integration test can connect to the configured local MCP endpoint.
- [x] `V1-04` Add event loop tick + idle sleep for orchestrator when no work exists. Test: run command stays alive for N seconds without crashing.
- [x] `V1-05` Add graceful shutdown for SIGINT/SIGTERM. Test: send SIGINT and assert clean exit code with no corrupted plan state.

- [x] `V1-06` Implement `spec.md` loading from `scriptorium/plan` branch worktree. Test: missing `spec.md` fails with clear error.
- [x] `V1-07` Detect "areas missing" condition from `/areas` directory. Test: empty areas directory triggers architect path once.
- [x] `V1-08` Add Architect invocation harness call using configured architect model. Test: mocked architect call receives spec text.
- [x] `V1-09` Persist generated area files and commit through orchestrator. Test: `git log` on plan branch contains area creation commit.
- [x] `V1-10` Make area creation idempotent (no duplicate rewrites when unchanged). Test: second run with same output creates no new commit.

- [x] `V1-11` Detect areas with zero open/in-progress tickets. Test: area with existing open ticket is skipped.
- [x] `V1-12` Add Manager invocation harness call per eligible area. Test: mocked manager is called once per eligible area.
- [x] `V1-13` Persist manager-created tickets into `tickets/open/` with stable IDs. Test: ticket filenames are unique and monotonic.
- [x] `V1-14` Commit ticket creation via orchestrator-only commit path. Test: commit author/message matches orchestrator policy.
- [x] `V1-15` Make ticket creation idempotent for unchanged manager output. Test: rerun does not duplicate tickets.

- [x] `V1-16` Implement oldest-open-ticket selection logic. Test: selector returns lexicographically oldest open ticket ID.
- [x] `V1-17` Move selected ticket `open/ -> in-progress/` in one commit. Test: after move, ticket exists in exactly one state directory.
- [x] `V1-18` Create and register code worktree for assigned ticket. Test: `git worktree list` includes ticket branch path.
- [x] `V1-19` Add cleanup path for finished/reopened tickets to remove stale worktrees. Test: closed ticket worktree is removed.

- [ ] `V1-20` Launch Coding Agent with ticket context (goal, acceptance criteria, notes). Test: mocked agent receives expected payload.
- [ ] `V1-21` Implement `submit_pr(summary)` handling and enqueue merge request metadata. Test: submit call creates queue entry.
- [ ] `V1-22` Implement merge queue single-flight processing (one merge job at a time). Test: second queued item waits until first completes.
- [ ] `V1-23` Merge `master` into ticket branch before tests. Test: integration test confirms merge step runs before `make test`.
- [ ] `V1-24` Execute `make test` in ticket worktree and capture exit code/output. Test: failing fixture repo returns non-zero and stores output.
- [ ] `V1-25` Success path: fast-forward merge to master and move ticket to `done/`. Test: passing fixture ends with ticket in `done/`.
- [ ] `V1-26` Failure path: move ticket back to `open/` and append failure notes. Test: failing fixture reopens ticket with failure note text.

- [ ] `V1-27` Add master-health gate before assigning new work. Test: with red master state, scheduler does not pick open tickets.
- [ ] `V1-28` Add global halt behavior while master is red. Test: orchestrator remains idle until master health is restored.

- [ ] `V1-29` Implement `status` command to report open/in-progress/done counts and active agent info. Test: CLI snapshot test for sample plan state.
- [ ] `V1-30` Implement `worktrees` command to list worktree path, ticket ID, and branch. Test: CLI output includes all active worktrees.
- [ ] `V1-31` Implement `plan` command to run architect conversation and update `spec.md`. Test: mocked architect update writes and commits new spec.

- [ ] `V1-32` Add invariant test: each ticket exists in exactly one state directory. Test: fixture with duplicated ticket fails validation.
- [ ] `V1-33` Add invariant test: every state transition is exactly one commit authored by orchestrator. Test: transition audit test passes.
- [ ] `V1-34` Add invariant test: no partial ticket moves on failure. Test: simulated crash leaves ticket in prior valid state.
- [ ] `V1-35` Add end-to-end V1 happy-path integration test (`spec -> areas -> tickets -> done`). Test: one fixture repo completes full flow.

## Codex Automation Plan (No tmux, Codex First)

The codex harness plan below refines `V1-20` and related execution work. Scope is codex-only for now, with a clean path to add claude later.

Testing split for this plan:
- `make test` runs local unit tests only (`tests/test_*.nim`) and should not require API keys.
- `make integration-test` runs real Codex integration tests (`tests/integration_*.nim`) and may require API keys.

- [ ] `CA-01` Create `src/scriptorium/harness_codex.nim` with `CodexRunRequest`, `CodexRunResult`, and `runCodex*(request)` API. Test: `nim check src/scriptorium/harness_codex.nim`.
- [ ] `CA-02` Run codex as a direct child process from Nim (`startProcess`) with prompt on stdin (non-interactive one-shot). Test: fake codex binary receives stdin prompt and exits successfully.
- [ ] `CA-03` Standardize codex command shape: `codex exec --json --output-last-message <file> --cd <worktree> --model <model> --dangerously-bypass-approvals-and-sandbox -`. Test: command builder unit test matches exact arg order.
- [ ] `CA-04` Capture and persist raw codex JSONL stream to `.scriptorium/logs/<ticket>/<attempt>.jsonl`. Test: run creates log file with non-empty content.
- [ ] `CA-05` Persist final agent message via `--output-last-message` and load it into `CodexRunResult`. Test: output file content is returned by harness result.
- [ ] `CA-06` Add watchdog timers: no-output timeout and hard runtime timeout; on timeout kill process and return structured failure. Test: fake stalled codex process is killed and flagged as timeout.
- [ ] `CA-07` Add bounded retry policy (for example max 2-3 attempts) with continuation prompt context. Test: first failed attempt + second success returns success with attempt count = 2.
- [ ] `CA-08` Add unit test coverage for codex harness with fake/stub codex process (success, non-zero exit, malformed output, timeout). Test: `make test` passes without network/API keys.
- [ ] `CA-09` Add integration tests in `tests/integration_*.nim` that run real codex on low-cost models (for example GPT-5.1 mini) behind env-key checks. Test: `make integration-test` runs when keys are present and skips cleanly when absent.
- [ ] `CA-10` Integrate codex harness into orchestrator ticket execution path after assignment (`V1-20`), storing run summary in ticket notes. Test: integration fixture shows ticket note appended with codex run result.
- [ ] `CA-11` Keep backend abstraction ready for future claude support (`runAgent` interface), but implement only codex backend now. Test: orchestrator execution path compiles against interface with codex as active implementation.
